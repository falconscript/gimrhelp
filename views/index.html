<h1> YouTube fixer stuff. </h1>


<div class="pre-auth">
  We need an OAuth token from the YouTube API in order to perform actions on your videos.
  <br />
  <br />
  Click here to open a google.com login window to authorize this script to perform changes:
  <br />
  <br />
  <a href="#" id="login-link">
    <input type="button" value="Authenticate" style="width:200px;height:100px;background:lightblue;" />
  </a>
</div>

<div class="post-auth" style="display:none">
  Authorized! Viewing videos now:

  <div id="video-container"></div>
  <div class="button-container">
    <button id="prev-button" class="paging-button">Previous Page</button>
    <button id="next-button" class="paging-button">Next Page</button>
  </div>

</div>


<style>
.ytvideo {
  padding:20px;
}
.ytthumbnail {
  width: 220px;
  height: 170px;
  display:block;
  float:left;
}
.yttitle {
  font-size:40px;
  height:170px;
  width:50%;
  font-weight:bold;
  display:block;
  float:left;
  margin-left:50px;
}
</style>


<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script>


var OAUTH2_CLIENT_ID = '13829284575-no267ep6v42gi1g7rqnph55hjfvomou5.apps.googleusercontent.com';
var OAUTH2_SCOPES = [
  'https://www.googleapis.com/auth/youtube'
];

// Upon loading, the Google APIs JS client automatically invokes this callback.
googleApiClientReady = function() {
  gapi.auth.init(function() {
    console.log("[D] Gonna check auth...");
    window.setTimeout(checkAuth, 1);
  });
}

// Attempt the immediate OAuth 2.0 client flow as soon as the page loads.
// If the currently logged-in Google Account has previously authorized
// the client specified as the OAUTH2_CLIENT_ID, then the authorization
// succeeds with no user intervention. Otherwise, it fails and the
// user interface that prompts for authorization needs to display.
function checkAuth() {
  gapi.auth.authorize({
    client_id: OAUTH2_CLIENT_ID,
    scope: OAUTH2_SCOPES,
    immediate: true
  }, handleAuthResult);
}

// Handle the result of a gapi.auth.authorize() call.
function handleAuthResult(authResult) {
  if (authResult && !authResult.error) {
    // Authorization was successful. Hide authorization prompts and show
    // content that should be visible after authorization succeeds.
    $('.pre-auth').hide();
    $('.post-auth').show();
    loadAPIClientInterfaces();
  } else {
    console.log("[D] Not already authenticated. Asking for permission...");

    // Make the #login-link clickable. Attempt a non-immediate OAuth 2.0
    // client flow. The current function is called when that flow completes.
    $('#login-link').click(function() {
      gapi.auth.authorize({
        client_id: OAUTH2_CLIENT_ID,
        scope: OAUTH2_SCOPES,
        immediate: false
        }, handleAuthResult);
    });
  }
}

// Load the client interfaces for the YouTube Analytics and Data APIs, which
// are required to use the Google APIs JS client. More info is available at
// http://code.google.com/p/google-api-javascript-client/wiki/GettingStarted#Loading_the_Client
function loadAPIClientInterfaces() {
  gapi.client.load('youtube', 'v3', function() {
    handleAPILoaded();
  });
}



function handleAPILoaded() {
  // AUTH RECEIVED. Load up video information
  console.log("[D] Authorized!");

  getAllVideos();
}




var allVidsData = {};
var ignoredVideos = {}; // for interest tracking
var DEBUG = true; // Turn on to prevent ignoring videos
var VID_LIMIT = 1000; // Concerned about API quota limits. Raise this if you're fearless

function getAllVideos() {
  // RESET videodata to be empty
  allVidsData = {};

  // Define some variables used to remember state.
  var playlistId, nextPageToken, prevPageToken;

  // Call the Data API to retrieve the playlist ID that uniquely identifies the
  // list of videos uploaded to the currently authenticated user's channel.
  function requestUserUploadsPlaylistId() {
    // See https://developers.google.com/youtube/v3/docs/channels/list
    var request = gapi.client.youtube.channels.list({
      mine: true,
      part: 'id,contentDetails'
    });
    request.execute(function(response) {
      playlistId = response.result.items[0].contentDetails.relatedPlaylists.uploads;
      requestVideoPlaylist(playlistId);
    });
  }

  // Retrieve the list of videos in the specified playlist.
  function requestVideoPlaylist(playlistId, pageToken) {
    $('#video-container').html('');
    var requestOptions = {
      playlistId: playlistId,
      part: 'snippet',
      maxResults: 50
    };
    if (pageToken) {
      requestOptions.pageToken = pageToken;
    }
    var request = gapi.client.youtube.playlistItems.list(requestOptions);
    request.execute(function(response) {


      // Only show pagination buttons if there is a pagination token for the
      // next or previous page of results.
      nextPageToken = response.result.nextPageToken;
      //var nextVis = nextPageToken ? 'visible' : 'hidden';
      //$('#next-button').css('visibility', nextVis);
      prevPageToken = response.result.prevPageToken
      //var prevVis = prevPageToken ? 'visible' : 'hidden';
      //$('#prev-button').css('visibility', prevVis);

      var playlistItems = response.result.items;
      if (playlistItems) {
        $.each(playlistItems, function(index, item) {

          // Add results into global variable to send back to server for thumbnail retreival
          // [id] => "video title"
          if (!DEBUG && item.snippet.title != "SF5 Smash 4 - Serge (Lucario) Vs. Darkfall (Link) SSB4 Tournament - Smash Wii U") {
            ignoredVideos[item.snippet.resourceId.videoId] = item.snippet.title;
          } else {
            allVidsData[item.snippet.resourceId.videoId] = item.snippet.title;
          }

        });

        // If more videos, grab them all.
        if (nextPageToken && Object.keys(allVidsData).length < VID_LIMIT) {
          requestVideoPlaylist(playlistId, nextPageToken);
        } else {

          console.log("[D] Done retrieving", Object.keys(allVidsData).length,
            "videos. Now sending to server to get thumbnails...");

          sendDataToBackend(allVidsData);
        }


      } else {
        $('#video-container').html(
          "Sorry you have no uploaded videos. If this seems wrong, verify on gmail.com you're logged in right."
        );
      }
    });
  }

  // Create a listing for a video.
  function displayResult(videoSnippet) {
    var title = videoSnippet.title;
    var videoId = videoSnippet.resourceId.videoId;
    $('#video-container').append(
      '<div class="ytvideo">' +
        '<img class="ytthumbnail" src="' + 'https://i.ytimg.com/vi/' + videoId + '/hqdefault.jpg?custom=true&w=360&h=202&stc=true&jpg444=true&jpgq=90&sp=68' + '" /> ' +
        '<div class="yttitle">' + title + ' - ' + videoId + '</div>' +
      '</div>'
    );
  }


  // Retrieve the next page of videos in the playlist.
  $('#next-button').on('click', function nextPage() {
    requestVideoPlaylist(playlistId, nextPageToken);
  });

  // Retrieve the previous page of videos in the playlist.
  $('#prev-button').on('click', function previousPage() {
    requestVideoPlaylist(playlistId, prevPageToken);
  });

  // PERFORM
  requestUserUploadsPlaylistId();
}

function sendDataToBackend(allVidsData) {
  $.ajax({
    dataType: "json",
    url: '/yt/yt_thumbnails_receive',
    data: allVidsData,
    type: 'POST', // Can send much more data than GET
    success: function (resObj, status, jqXHR) {
      console.log("[D] Received full thumbnail data with video suggestions:", Object.keys(resObj).length, "items.");
      displayVideoResults(resObj);
    },
    error: function() {
      alert("WARNING! Sending the video data to the backend failed. Maybe a timeout happened? STOPPING. YOU STOP TOO.")
    }
  });
}

function displayVideoResults(videoData) {
  // clear
  $('#video-container').html('');

  $.each(videoData, function (id, vidInfo) {

    $('#video-container').append(
      '<div class="ytvideo">' +
        '<img class="ytthumbnail" src="' + 'https://i.ytimg.com/vi/' + id + '/hqdefault.jpg?custom=true&w=360&h=202&stc=true&jpg444=true&jpgq=90&sp=68' + '" /> ' +
        '<div class="yttitle">' + id + ' - ' + vidInfo + '</div>' +
      '</div>'
    );

  });

  // Now show CONTROLS on top right for rename actions.
  $('.controls').show();

}


function performUpdates() {
  // grab updated names from HTML in page, displayed/possibly edited?

  // $('.videos') ...

  // send update API request for video

  var resource = {
    snippet: {
      title: video.snippet.title,
      description: updatedDescription,
      categoryId: '22'
    },
    id: video.snippet.resourceId.videoId
  };
  YouTube.Videos.update(resource, 'id,snippet');

}

</script>
<script src="https://apis.google.com/js/client.js?onload=googleApiClientReady"></script>
